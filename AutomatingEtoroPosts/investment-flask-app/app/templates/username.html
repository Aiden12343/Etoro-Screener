{% extends "base.html" %}

{% block title %}User Performance{% endblock %}

{% block content %}
<div class="profile-header-container">
    <div class="profile-header">
        <div class="avatar-container">
            <img src="{{ user_heatmap_data.avatar_url }}" alt="User Avatar" class="avatar">
        </div>
        <div class="user-info">
            <h1>{{ username }}</h1>
            <p><strong>Country:</strong> {{ user_heatmap_data.Country }}</p>
            <p><strong>Account Age:</strong> {{ (user_heatmap_data.WeeksSinceRegistration * 7) | round(0, 'floor') }} days</p>
            <p><strong>Last Time Online:</strong> {{ user_heatmap_data.LastActivity[:10] | replace('-', '/') }}</p>
        </div>
    </div>
    <div class="heatmap">
        <div class="heatmap-box" id="gain-box">
            <p>1Y Return</p>
            <p>{{ user_heatmap_data.Gain }}%</p>
        </div>
        <div class="heatmap-box" id="daily-gain-box">
            <p>Today's Return</p>
            <p>{{ user_heatmap_data.DailyGain }}%</p>
        </div>
        <div class="heatmap-box" id="this-week-gain-box">
            <p>This Week Gain</p>
            <p>{{ user_heatmap_data.ThisWeekGain }}%</p>
        </div>
        <div class="heatmap-box" id="risk-score-box">
            <p>Risk Score</p>
            <p>{{ user_heatmap_data.RiskScore }}</p>
        </div>
        <div class="heatmap-box" id="copiers-box">
            <p>Copiers</p>
            <p>{{ user_heatmap_data.Copiers }}</p>
        </div>
        <div class="heatmap-box" id="trades-box">
            <p>Trades</p>
            <p>{{ user_heatmap_data.Trades }}</p>
        </div>
        <div class="heatmap-box" id="win-ratio-box">
            <p>Win Ratio</p>
            <p>{{ user_heatmap_data.WinRatio }}%</p>
        </div>
        <div class="heatmap-box" id="profitable-months-box">
            <p>Profitable Months</p>
            <p>{{ user_heatmap_data.ProfitableMonthsPct }}%</p>
        </div>
        <div class="heatmap-box" id="drawdown-box">
            <p>Worst Drawdown</p>
            <p>{{ user_heatmap_data.PeakToValley }}% :{{ user_heatmap_data.PeakToValleyStart[:10] | replace('-', '/') }} - {{ user_heatmap_data.PeakToValleyEnd[:10] | replace('-', '/') }}</p>
        </div>
    </div>
</div>

<div class="portfolio-container">
    <h2>Current Stock Portfolio</h2>
    <input type="text" id="search-input" placeholder="Search by Ticker Name" onkeyup="filterTable()">
    <button onclick="filterTable()">Search</button>
    <table id="portfolio-table">
        <thead>
            <tr>
                <th><a href="?sort=instrument_id&order={{ next_order }}&page=1">Instrument ID</a></th>
                <th><a href="?sort=ticker_name&order={{ next_order }}&page=1">Ticker Name</a></th>
                <th><a href="?sort=direction&order={{ next_order }}&page=1">Direction</a></th>
                <th><a href="?sort=invested&order={{ next_order }}&page=1">Invested</a></th>
                <th><a href="?sort=net_profit&order={{ next_order }}&page=1">Net Profit</a></th>
                <th><a href="?sort=value&order={{ next_order }}&page=1">Value</a></th>
            </tr>
        </thead>
        <tbody>
            {% for position in portfolio_data %}
            <tr>
                <td><a href="{{ url_for('ticker', ticker_name=position.ticker_name) }}">{{ position.instrument_id }}</a></td>
                <td><a href="{{ url_for('ticker', ticker_name=position.ticker_name) }}">{{ position.ticker_name }}</a></td>
                <td>{{ position.direction }}</td>
                <td>{{ position.invested }}</td>
                <td class="{{ 'positive' if position.net_profit >= 0 else 'negative' }}">{{ position.net_profit }}</td>
                <td class="{{ 'positive' if position.value >= 0 else 'negative' }}">{{ position.value }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="pagination">
        {% if page > 1 %}
        <a href="?sort={{ sort_by }}&order={{ sort_order }}&page={{ page - 1 }}" class="page-button" onclick="storeScrollPosition()">Previous</a>
        {% endif %}
        {% if portfolio_data|length > 5 %}
        <a href="?sort={{ sort_by }}&order={{ sort_order }}&page={{ page + 1 }}" class="page-button" onclick="storeScrollPosition()">Next</a>
        {% endif %}
    </div>
</div>

<div class="risk-exposure-container">
    <h2>Risk Exposure for{{ username }}</h2>
    <canvas id="riskExposureChart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-3d"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('riskExposureChart').getContext('2d');
        const riskExposureData = JSON.parse('{{ risk_exposure_data | tojson | safe }}');
        const labels = riskExposureData.map(item => item.ticker_name);
        const data = riskExposureData.map(item => item.riskContributionPct);
        const backgroundColors = labels.map(() => `hsl(${Math.random() * 360}, 100%, 75%)`);

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Risk Contribution (%)',
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: backgroundColors.map(color => color.replace('75%', '50%')),
                    borderWidth: 1
                }]
            },
            options: {
                plugins: {
                    datalabels: {
                        display: true,
                        color: 'black'
                    },
                    chart3d: {
                        enabled: true,
                        alpha: 45,
                        beta: 0,
                        depth: 50,
                        viewDistance: 25,
                        axis: {
                            x: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            y: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    });
</script>
{% endblock %}

{% block styles %}
<style>
    .profile-header-container {
        display: flex;
        align-items: flex-start;
        margin-bottom: 20px;
    }
    .profile-header {
        display: flex;
        align-items: center;
        background-color: #2c3e50;
        padding: 20px;
        border-radius: 5px;
        color: white;
        width: calc(3 * 150px + 2 * 10px); /* Width of three heatmap boxes */
        margin-right: 10px;
    }
    .avatar-container {
        flex: 0 0 150px;
        margin-right: 20px;
    }
    .avatar {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
    }
    .user-info {
        flex: 1;
    }
    .heatmap {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        flex: 1;
    }
    .heatmap-box {
        flex: 0 0 150px;
        padding: 20px;
        background-color: #2c3e50;
        color: white;
        border-radius: 5px;
        text-align: center;
    }
    .heatmap-box p {
        margin: 0;
    }
    .portfolio-container {
        width: 100%;
        margin-top: 20px;
    }
    .portfolio-container h2 {
        display: inline-block;
        margin-right: 10px;
    }
    .portfolio-container input {
        padding: 5px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 5px;
        margin-right: 10px;
    }
    .portfolio-container button {
        padding: 5px 10px;
        font-size: 16px;
        border: none;
        background-color: #3498db;
        color: white;
        border-radius: 5px;
        cursor: pointer;
    }
    .portfolio-container button:hover {
        background-color: #2980b9;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        box-shadow: 0 2px 3px rgba(0, 0, 0, 0.1);
        background-color: #000; /* Black background for the table */
    }
    th, td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #333;
        border-right: 1px solid #333;
        cursor: pointer;
    }
    th {
        background-color: #2c3e50;
        color: white;
        position: sticky;
        top: 0;
        z-index: 1;
    }
    th:last-child, td:last-child {
        border-right: none;
    }
    tr:hover {
        background-color: #333;
    }
    a {
        color: #3498db;
        text-decoration: none;
    }
    a:hover {
        text-decoration: underline;
    }
    .positive {
        color: #00ff00;
    }
    .negative {
        color: #ff0000;
    }
    .pagination {
        text-align: center;
        margin-top: 20px;
    }
    .page-button {
        display: inline-block;
        margin: 0 5px;
        padding: 10px 20px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
    }
    .page-button:hover {
        background-color: #2980b9;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    function setHeatmapColor(elementId, value, thresholds) {
        const element = document.getElementById(elementId);
        if (value >= thresholds.good) {
            element.style.backgroundColor = '#00ff00'; // Green for good
        } else if (value >= thresholds.average) {
            element.style.backgroundColor = '#ffff00'; // Yellow for average
        } else {        
            element.style.backgroundColor = '#ff0000'; // Red for bad
        }
    }

    function storeScrollPosition() {
        localStorage.setItem('scrollPosition', window.scrollY);
    }

    function restoreScrollPosition() {
        const scrollPosition = localStorage.getItem('scrollPosition');
        if (scrollPosition) {
            window.scrollTo(0, parseInt(scrollPosition));
            localStorage.removeItem('scrollPosition');
        }
    }

    function filterTable() {
        const input = document.getElementById('search-input');
        const filter = input.value.toUpperCase();
        const table = document.getElementById('portfolio-table');
        const tr = table.getElementsByTagName('tr');

        for (let i = 1; i < tr.length; i++) {
            const td = tr[i].getElementsByTagName('td')[1];
            if (td) {
                const txtValue = td.textContent || td.innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = '';
                } else {
                    tr[i].style.display = 'none';
                }
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const userHeatmapData = JSON.parse('{{ user_heatmap_data|tojson|safe }}');
        setHeatmapColor('gain-box', userHeatmapData.Gain, { good: 50, average: 0 });
        setHeatmapColor('daily-gain-box', userHeatmapData.DailyGain, { good: 1, average: -1 });
        setHeatmapColor('this-week-gain-box', userHeatmapData.ThisWeekGain, { good: 1, average: -1 });
        setHeatmapColor('risk-score-box', userHeatmapData.RiskScore, { good: 3, average: 5 });
        setHeatmapColor('copiers-box', userHeatmapData.Copiers, { good: 100, average: 50 });
        setHeatmapColor('trades-box', userHeatmapData.Trades, { good: 200, average: 100 });
        setHeatmapColor('win-ratio-box', userHeatmapData.WinRatio, { good: 60, average: 50 });
        setHeatmapColor('profitable-months-box', userHeatmapData.ProfitableMonthsPct, { good: 60, average: 50 });

        restoreScrollPosition();
    });
</script>
{% endblock %}